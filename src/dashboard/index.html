<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pussla Dashboard</title>
  <style>
    :root {
      --bg: #f5f7fa;
      --panel: #ffffff;
      --ink: #10222f;
      --muted: #6f7f8b;
      --line: #dbe2e8;
      --accent: #005f73;
      --ok: #2a9d8f;
      --warn: #e9c46a;
      --bad: #e76f51;
      --none: #edf2f7;
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "IBM Plex Sans", "Segoe UI", sans-serif;
      color: var(--ink);
      background: radial-gradient(circle at top right, #c9f3ef 0%, var(--bg) 30%), var(--bg);
    }

    .layout { display: grid; grid-template-columns: 280px 1fr; min-height: 100vh; }

    aside {
      background: linear-gradient(180deg, #0b3142 0%, #164d66 100%);
      color: #e2edf2;
      padding: 24px;
      border-right: 1px solid rgba(255,255,255,0.08);
    }

    .brand h1 { margin: 0; font-size: 1.4rem; }
    .brand p { margin: 8px 0 0; color: #a9c5d3; font-size: 0.85rem; }

    .control { margin-top: 24px; }
    .control label { display: block; font-size: 0.8rem; text-transform: uppercase; letter-spacing: .06em; color: #9fc0cf; margin-bottom: 8px; }

    input[type="text"] {
      width: 100%;
      border: 1px solid #2e6277;
      background: #0e3c52;
      color: #e5f3f9;
      border-radius: 10px;
      padding: 10px;
    }

    .toggle {
      margin-top: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.9rem;
      color: #c9dee8;
    }

    main { padding: 24px; overflow: auto; }

    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
      margin-bottom: 18px;
    }

    .card {
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 14px;
    }

    .card .label { color: var(--muted); font-size: 0.85rem; }
    .card .value { font-size: 1.5rem; font-weight: 700; margin-top: 6px; }

    .table-wrap {
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 12px;
      overflow: auto;
    }

    table { border-collapse: collapse; width: 100%; min-width: 900px; }
    th, td { border-bottom: 1px solid var(--line); padding: 8px; text-align: center; }
    td:first-child {
      position: sticky;
      left: 0;
      background: var(--panel);
      text-align: left;
      min-width: 220px;
      z-index: 1;
    }
    th {
      position: sticky;
      top: 0;
      background: #f0f4f8;
      color: #385061;
      font-size: 0.78rem;
      text-transform: uppercase;
      z-index: 2;
    }
    thead tr.head-year th { top: 0; z-index: 4; }
    thead tr.head-month th { top: 33px; z-index: 3; text-transform: none; }
    thead tr.head-week th { top: 66px; z-index: 2; }
    th.row-header {
      position: sticky;
      left: 0;
      top: 0;
      z-index: 5;
      text-transform: uppercase;
      text-align: left;
      min-width: 220px;
    }
    .month-cell {
      display: grid;
      gap: 2px;
      justify-items: center;
      line-height: 1.1;
    }
    .month-util {
      color: var(--muted);
      font-size: 0.72rem;
      font-weight: 600;
    }
    tfoot td {
      background: #f0f4f8;
      font-weight: 700;
      color: #385061;
      border-top: 2px solid var(--line);
    }
    td.footer-label {
      text-align: left;
      min-width: 220px;
    }

    .name { font-weight: 600; }
    .role { color: var(--muted); font-size: 0.78rem; }

    .cell {
      border-radius: 7px;
      padding: 5px 6px;
      font-size: 0.78rem;
      font-weight: 700;
      min-width: 54px;
      cursor: pointer;
    }

    .load-none { background: var(--none); color: #9ca8b5; }
    .load-low { background: var(--warn); color: #fff; }
    .load-ok { background: var(--ok); color: #fff; }
    .load-bad { background: var(--bad); color: #fff; }

    #details {
      margin-top: 12px;
      background: #f7fbfd;
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 14px;
      display: none;
    }

    #details h3 { margin: 0 0 8px; }
    #details ul { margin: 0; padding-left: 18px; }
    #details li { margin-bottom: 4px; }

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(16, 34, 47, 0.45);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 16px;
      z-index: 20;
    }

    .modal {
      width: min(760px, 100%);
      background: #fff;
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 16px;
    }

    .modal h3 { margin: 0 0 10px; }
    .modal-grid { display: grid; gap: 8px; margin-bottom: 10px; }
    .edit-row {
      display: grid;
      grid-template-columns: 1fr 120px 90px;
      gap: 8px;
      align-items: center;
    }
    .edit-row input {
      border: 1px solid var(--line);
      border-radius: 8px;
      padding: 8px;
      font: inherit;
    }
    .edit-row button,
    .modal-actions button {
      border: 1px solid var(--line);
      border-radius: 8px;
      padding: 8px 10px;
      background: #f6f9fb;
      cursor: pointer;
    }
    .modal-actions {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      margin-top: 12px;
    }
    .modal-error {
      color: #b42318;
      font-size: 0.85rem;
      min-height: 1.2rem;
    }

    @media (max-width: 960px) {
      .layout { grid-template-columns: 1fr; }
      aside { border-right: 0; border-bottom: 1px solid rgba(255,255,255,0.08); }
      main { padding: 12px; }
    }
  </style>
</head>
<body>
  <div class="layout">
    <aside>
      <div class="brand">
        <h1>üß© Pussla Dashboard</h1>
        <p>Lokal vy f√∂r planering och bel√§ggning</p>
      </div>

      <div class="control">
        <label for="search">S√∂k</label>
        <input id="search" type="text" placeholder="Namn eller alias" />
      </div>

      <label class="toggle">
        <input id="pii" type="checkbox" checked />
        Visa personuppgifter (PII)
      </label>

      <p id="generated" style="margin-top:16px;color:#a9c5d3;font-size:.8rem"></p>
    </aside>

    <main>
      <section class="stats">
        <div class="card"><div class="label">Antal personer</div><div class="value" id="stat-users">-</div></div>
        <div class="card"><div class="label">Genomsnittlig bel√§ggning</div><div class="value" id="stat-util">-</div></div>
        <div class="card"><div class="label">√ñverbokade veckoslots</div><div class="value" id="stat-over">-</div></div>
      </section>

      <section class="table-wrap">
        <table id="heatmap"></table>
      </section>

      <section id="details"></section>
    </main>
  </div>

  <div id="editor-backdrop" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="editor-title">
    <div class="modal">
      <h3 id="editor-title">Redigera vecka</h3>
      <div id="editor-meta" class="role"></div>
      <div id="editor-total" class="name" style="margin:8px 0 10px;"></div>
      <div id="editor-rows" class="modal-grid"></div>
      <button id="editor-add" type="button">+ L√§gg till projekt</button>
      <div id="editor-error" class="modal-error"></div>
      <div class="modal-actions">
        <button id="editor-cancel" type="button">Avbryt</button>
        <button id="editor-save" type="button">Spara √§ndringar</button>
      </div>
    </div>
  </div>

  <script src="/week_format.js"></script>
  <script src="/header_groups.js"></script>
  <script>
    const search = document.getElementById('search');
    const pii = document.getElementById('pii');
    const heatmap = document.getElementById('heatmap');
    const details = document.getElementById('details');
    const editorBackdrop = document.getElementById('editor-backdrop');
    const editorRows = document.getElementById('editor-rows');
    const editorMeta = document.getElementById('editor-meta');
    const editorTotal = document.getElementById('editor-total');
    const editorError = document.getElementById('editor-error');
    const editorAdd = document.getElementById('editor-add');
    const editorCancel = document.getElementById('editor-cancel');
    const editorSave = document.getElementById('editor-save');

    let dashboardData = null;
    let editorState = null;

    function loadClass(load) {
      if (load === 0) return 'load-none';
      if (load > 100) return 'load-bad';
      if (load >= 80) return 'load-ok';
      return 'load-low';
    }

    function escapeHtml(value) {
      return String(value)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    function render() {
      if (!dashboardData) return;

      const term = search.value.trim().toLowerCase();
      const users = dashboardData.users.filter(user => {
        const displayName = user.display_name.toLowerCase();
        const alias = user.alias.toLowerCase();
        return !term || displayName.includes(term) || alias.includes(term);
      });

      const weeks = dashboardData.weeks;
      const { yearGroups, monthGroups } = buildCalendarGroups(weeks);
      // Monthly percentages are the average total_load across displayed user-week slots per month group.
      const monthPercents = calculateMonthAllocationPercentages({
        weeks,
        users,
        monthGroups,
      });
      // Weekly footer percentages are the average total_load across displayed users per week column.
      const weekPercents = calculateWeekAllocationPercentages({ weeks, users });
      const renderPercent = (value) => `${Number(value).toFixed(1).replace(/\.0$/, "")}%`;
      const head = `
        <thead>
          <tr class="head-year">
            <th class="row-header" rowspan="3">Person</th>
            ${yearGroups.map(group => `<th colspan="${group.span}">${group.label}</th>`).join('')}
          </tr>
          <tr class="head-month">
            ${monthGroups.map((group, idx) => `
              <th colspan="${group.span}">
                <div class="month-cell">
                  <div>${group.label}</div>
                  <div class="month-util">${renderPercent(monthPercents[idx])}</div>
                </div>
              </th>
            `).join('')}
          </tr>
          <tr class="head-week">
            ${weeks.map(w => `<th>${formatWeekLabel(w)}</th>`).join('')}
          </tr>
        </thead>
      `;

      const body = users.map(user => {
        const person = `
          <div class="name">${user.display_name}</div>
          <div class="role">${user.alias} ‚Ä¢ ${user.role}</div>
        `;

        const cells = user.weekly_stats.map(slot => {
          const label = slot.total_load === 0 ? '-' : `${slot.total_load}%`;
          const encoded = encodeURIComponent(JSON.stringify({ user, slot }));
          return `<td><div class="cell ${loadClass(slot.total_load)}" data-details="${encoded}">${label}</div></td>`;
        }).join('');

        return `<tr><td>${person}</td>${cells}</tr>`;
      }).join('');

      const foot = `
        <tfoot>
          <tr>
            <td class="footer-label">Veckobel√§ggning</td>
            ${weekPercents.map(value => `<td>${renderPercent(value)}</td>`).join('')}
          </tr>
        </tfoot>
      `;

      heatmap.innerHTML = `${head}<tbody>${body}</tbody>${foot}`;

      heatmap.querySelectorAll('.cell').forEach(el => {
        el.addEventListener('click', () => {
          const raw = el.getAttribute('data-details');
          if (!raw) return;
          const { user, slot } = JSON.parse(decodeURIComponent(raw));
          openEditor(user, slot);
        });
      });
    }

    function renderDetails(user, slot) {
      if (!slot.projects || slot.projects.length === 0) {
        details.style.display = 'none';
        details.innerHTML = '';
        return;
      }

      const items = slot.projects.map(project => {
        const context = project.context || {};
        const summary = context.summary ? ` ‚Äì ${context.summary}` : '';
        return `<li><strong>${project.project}</strong>: ${project.load}%${summary}</li>`;
      }).join('');

      details.innerHTML = `
        <h3>${user.display_name} ‚Ä¢ ${formatWeekLabel(slot.week)} ‚Ä¢ ${slot.total_load}%</h3>
        <ul>${items}</ul>
      `;
      details.style.display = 'block';
    }

    function getProjectChoices() {
      const choices = new Set();
      if (!dashboardData || !Array.isArray(dashboardData.raw_allocations)) return [];
      dashboardData.raw_allocations.forEach(entry => {
        if (entry && typeof entry.project === 'string' && entry.project.trim()) {
          choices.add(entry.project.trim());
        }
      });
      return Array.from(choices).sort((a, b) => a.localeCompare(b));
    }

    function drawEditorRows() {
      if (!editorState) return;
      const options = getProjectChoices();
      const rowsHtml = editorState.rows.map((row, idx) => {
        const load = Number.isFinite(row.load) ? row.load : 0;
        return `
          <div class="edit-row" data-index="${idx}">
            <input type="text" class="edit-project" list="project-options" value="${escapeHtml(row.project)}" placeholder="Projekt" />
            <input type="number" class="edit-load" value="${load}" min="0" step="1" />
            <button type="button" class="edit-remove">Ta bort</button>
          </div>
        `;
      }).join('');
      editorRows.innerHTML = `
        <datalist id="project-options">
          ${options.map(name => `<option value="${escapeHtml(name)}"></option>`).join('')}
        </datalist>
        ${rowsHtml}
      `;
      refreshEditorTotal();
    }

    function refreshEditorTotal() {
      if (!editorState) return;
      const total = editorState.rows.reduce((acc, row) => acc + (Number.isFinite(row.load) ? row.load : 0), 0);
      editorTotal.textContent = `Total vecka: ${total}%`;
    }

    function setEditorError(message) {
      editorError.textContent = message || '';
    }

    function openEditor(user, slot) {
      const rows = (slot.projects || []).map(project => ({
        project: String(project.project || '').trim(),
        load: Number.isFinite(project.load) ? project.load : 0,
      }));

      editorState = {
        alias: user.alias,
        displayName: user.display_name,
        week: slot.week,
        rows: rows.length ? rows : [{ project: '', load: 0 }],
      };

      editorMeta.textContent = `${editorState.displayName} (${editorState.alias}) ‚Ä¢ ${formatWeekLabel(editorState.week)}`;
      setEditorError('');
      drawEditorRows();
      editorBackdrop.style.display = 'flex';
    }

    function closeEditor() {
      editorState = null;
      editorBackdrop.style.display = 'none';
      setEditorError('');
    }

    function collectEditorPayload() {
      if (!editorState) {
        throw new Error('No editor state available');
      }

      const rows = Array.from(editorRows.querySelectorAll('.edit-row'));
      const allocations = [];
      for (const row of rows) {
        const projectInput = row.querySelector('.edit-project');
        const loadInput = row.querySelector('.edit-load');
        const project = String(projectInput?.value || '').trim();
        const loadRaw = String(loadInput?.value || '').trim();
        if (!project && !loadRaw) continue;
        if (!project) throw new Error('Projekt m√•ste anges f√∂r varje rad');
        if (!/^\d+$/.test(loadRaw)) throw new Error('Bel√§ggning m√•ste vara ett heltal >= 0');
        const load = Number(loadRaw);
        allocations.push({ project, load });
      }

      return {
        alias: editorState.alias,
        week: editorState.week,
        allocations,
      };
    }

    async function saveEditor() {
      if (!editorState) return;
      setEditorError('');
      let payload;
      try {
        payload = collectEditorPayload();
      } catch (err) {
        setEditorError(err instanceof Error ? err.message : String(err));
        return;
      }

      if (!window.confirm('Spara √§ndringar f√∂r denna vecka?')) {
        return;
      }

      editorSave.disabled = true;
      try {
        const res = await fetch('/api/allocation/update', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) {
          throw new Error(data.error || 'Kunde inte spara √§ndringarna');
        }
        closeEditor();
        await loadData();
      } catch (err) {
        setEditorError(err instanceof Error ? err.message : String(err));
      } finally {
        editorSave.disabled = false;
      }
    }

    async function loadData() {
      const includePii = pii.checked ? '1' : '0';
      const res = await fetch(`/api/dashboard-data?include_pii=${includePii}`);
      dashboardData = await res.json();

      document.getElementById('stat-users').textContent = dashboardData.metrics.users_count;
      document.getElementById('stat-util').textContent = `${dashboardData.metrics.average_utilization}%`;
      document.getElementById('stat-over').textContent = dashboardData.metrics.overbooked_slots;
      document.getElementById('generated').textContent = `Genererad: ${dashboardData.generated_at}`;

      details.style.display = 'none';
      details.innerHTML = '';
      render();
    }

    search.addEventListener('input', render);
    pii.addEventListener('change', loadData);
    editorAdd.addEventListener('click', () => {
      if (!editorState) return;
      editorState.rows.push({ project: '', load: 0 });
      drawEditorRows();
    });
    editorCancel.addEventListener('click', closeEditor);
    editorSave.addEventListener('click', saveEditor);
    editorBackdrop.addEventListener('click', (event) => {
      if (event.target === editorBackdrop) closeEditor();
    });
    editorRows.addEventListener('input', (event) => {
      const target = event.target;
      if (!(target instanceof HTMLElement)) return;
      const rowEl = target.closest('.edit-row');
      if (!rowEl || !editorState) return;
      const idx = Number(rowEl.getAttribute('data-index'));
      if (!Number.isInteger(idx) || idx < 0 || idx >= editorState.rows.length) return;
      if (target.classList.contains('edit-project')) {
        editorState.rows[idx].project = target.value;
      }
      if (target.classList.contains('edit-load')) {
        const v = Number(target.value);
        editorState.rows[idx].load = Number.isFinite(v) ? Math.max(0, Math.trunc(v)) : 0;
      }
      refreshEditorTotal();
    });
    editorRows.addEventListener('click', (event) => {
      const target = event.target;
      if (!(target instanceof HTMLElement)) return;
      if (!target.classList.contains('edit-remove') || !editorState) return;
      const rowEl = target.closest('.edit-row');
      if (!rowEl) return;
      const idx = Number(rowEl.getAttribute('data-index'));
      if (!Number.isInteger(idx) || idx < 0 || idx >= editorState.rows.length) return;
      editorState.rows.splice(idx, 1);
      if (editorState.rows.length === 0) {
        editorState.rows.push({ project: '', load: 0 });
      }
      drawEditorRows();
    });

    loadData().catch(err => {
      heatmap.innerHTML = `<tbody><tr><td>Kunde inte ladda data: ${err}</td></tr></tbody>`;
    });
  </script>
</body>
</html>
